<!DOCTYPE html>
<html>
<head></head>
<body>

<h1>An example of extracting text from a pdf</h1>
Type in the url to view a pdf (ie: https://raw.githubusercontent.com/CodeSolutions2/pdf_to_text_webapp/main/document.pdf).

<!-- ---------------------------------------- -->
<!-- Input -->
<input id="pdf_dataset_url" type="text" value="" placeholder="pdf_dataset_url" rows="10" cols="100" style="display:block; text-align: left; width: 600px;">
<input id="OPENAI_API_KEY" type="text" value="" placeholder="OPENAI_API_KEY" rows="10" cols="100" style="display:block; text-align: left; width: 150px;">
<!-- ---------------------------------------- -->
<br>
<!-- ---------------------------------------- -->
<!-- Buttons -->
<button id="show_pdf_wo_CORS" onclick="show_pdf_wo_CORS()">[Step 0] show_pdf_wo_CORS</button>
<br>
<button id="show_pdf_w_CORS" onclick="show_pdf_w_CORS()">[Step 0] show_pdf_w_CORS</button>
<br>
<button id="read_text_from_pdf" onclick="read_text_from_pdf()">[Step 1] read_text_from_pdf</button>
<br>
<button id="transcribe_pdf" onclick="transcribe_pdf()">[Step 1] transcribe_pdf</button>
<br>
<button id="extract_text_from_pdf_using_OpenAI_assistant" onclick="extract_text_from_pdf_using_OpenAI_assistant()">[Step 1] extract_text_from_pdf_using_OpenAI_assistant</button>
<!-- ---------------------------------------- -->
<br>

<!-- <object style="display:none" data="document.pdf" type="application/pdf" width="800" height="1200"></object> -->

<!-- Way 0: Step 2  -->
<div id="output" style="display:none;font-family:courier;font-size:24px;height:300px"></div>


<canvas id="the-canvas" style="border: 1px solid black; direction: ltr;"></canvas>
	

<!-- Try 0 -->
<!-- this loads: https://www.jsdelivr.com/package/npm/pdfjs-dist -->
<!-- <script type="module"> import pdfjsDist from 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.1.392/+esm' </script> -->
<!--  OK -->

<!-- Try 1 -->
<!-- <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@4.1.392/+esm"></script> -->
<!-- Uncaught SyntaxError: export declarations may only appear at top level of a module -->

<!-- Try 2 -->
<!-- <script type="text/javascript" src="https://unpkg.com/browse/pdfjs-dist@4.2.67"></script> -->
<!-- The resource from “https://unpkg.com/browse/pdfjs-dist@4.2.67” was blocked due to MIME type (“text/html”) mismatch (X-Content-Type-Options: nosniff). -->

	
<script type="text/javascript">
	
const outp = document.getElementById('output');

const file_download_url = document.getElementById("pdf_dataset_url").value;
const OPENAI_API_KEY = document.getElementById("OPENAI_API_KEY").value;

// var FILE_ID = "file-1kLxcQsAJqbyxB2qdjr81XAl";	// blob
var FILE_ID = "file-Fw9epDVe1nRf3yuNAWDbQJUp";		// file.pdf
const THREAD_ID = "thread_LQGBDZQ5WHHa9I4sgRYCdV5F";
const ASSISTANT_ID = "asst_yrvoqgXkLxATkK0lZLzGGK5R";
const RUN_ID = "";

// ----------------------------------------------------
// Step 0
// ----------------------------------------------------
	
// Show pdf without CORS
async function show_pdf_wo_CORS() {
	
	let file_download_url_name = file_download_url.split('/').pop();
	console.log("file_download_name: ", file_download_url_name);

	// objectElement works
	// https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe
	// https://developer.mozilla.org/en-US/docs/Learn/HTML/Multimedia_and_embedding/Other_embedding_technologies
	var objectElement = document.createElement('object');
	objectElement.setAttribute("type", "application/pdf");
	objectElement.setAttribute("width", 800);
	objectElement.setAttribute("height", 1200);

	// one needs to only put the name of the pdf, instead of the full html_url because the fetch labels the data as cross-site instead of same-site
	objectElement.setAttribute("data", file_download_url_name);
	document.body.appendChild(objectElement);
}

// ----------------------------------------------------

// Show pdf WITH CORS
async function show_pdf_w_CORS() {
	
	// Try 0: using embed 
	// var embedElement = document.createElement('embed');
	// embedElement.setAttribute("id", "pdf");
	// embedElement.setAttribute("type", "application/pdf");
	// embedElement.setAttribute("width", 800);
	// embedElement.setAttribute("height", 1200);
	// embedElement.setAttribute("src", file_download_url);
	// document.body.appendChild(embedElement);
	// Forbidden to open pdf file from crosss-domain

	// var embedElement = document.createElement('embed');
	// embedElement.setAttribute('crossOrigin', "");
	// embedElement.setAttribute('headers', {"Content-Type": "application/json", "Access-Control-Allow-Origin": "*"});
	// embedElement.setAttribute("id", "pdf");
	// embedElement.setAttribute("type", "application/pdf");
	// embedElement.setAttribute("width", 800);
	// embedElement.setAttribute("height", 1200);
	// embedElement.setAttribute("src", file_download_url);
	// document.body.appendChild(embedElement);
	// The loading of “https://raw.githubusercontent.com/CodeSolutions2/pdf_to_text_webapp/main/document.pdf” in a frame is denied by “X-Frame-Options“ directive set to “deny“.

	var objectElement = document.createElement('object');
	objectElement.setAttribute('crossOrigin', "");

	// https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/X-Frame-Options?utm_source=mozilla&utm_medium=firefox-console-errors&utm_campaign=default
	// objectElement.setAttribute('headers', {"Content-Type": "application/json", "Access-Control-Allow-Origin": "*"});
	// objectElement.setAttribute("xFrameOptions", { action: "sameorigin" });
	objectElement.setAttribute('Content-Security-Policy', 'frame-ancestors sameorigin');
	
	objectElement.setAttribute("type", "application/pdf");
	objectElement.setAttribute("width", 800);
	objectElement.setAttribute("height", 1200);
	objectElement.setAttribute("data", file_download_url);
	document.body.appendChild(objectElement);
	
	// Try 1: using an iframe
	// The iframe on the main page is connected to another iframe on a new page
	// So, one can open a cross-origin file in a new window, but not in the same window 
	// var iframeElement = document.createElement('iframe');
	// iframeElement.style.width = '100%';
	// iframeElement.style.height = '100%';
	// iframeElement.style.display = 'none';
	// document.body.appendChild(iframeElement); // it can not open the new window if the Element is not added to the DOM
	// var contentWindow = iframeElement.contentWindow;
	// contentWindow.document.open();
	// contentWindow.document.write('<iframe src="' + file_download_url + '" onload="print();" width="1000" height="1200" frameborder="0" marginheight="0" marginwidth="0">');
	// contentWindow.document.close();
	// It opens a new page with the pdf inside, and then it automatically downloads the pdf using print on the original page

	// Try 2: using an object
	// var objectElement = document.createElement('object');
	// document.body.appendChild(objectElement);  // it can not open the new window if the Element is not added to the DOM
	// var contentWindow = objectElement.contentWindow;
	// contentWindow.document.open();
	// contentWindow.document.write('<iframe src="' + file_download_url + '" onload="print();" width="1000" height="1200" frameborder="0" marginheight="0" marginwidth="0">');
	// contentWindow.document.close();
	//  TypeError: contentWindow is null

}
	
// ----------------------------------------------------







// ----------------------------------------------------
// Step 1
// ----------------------------------------------------
	
// Way 0: try reading text from the pdf
// WORKS
async function read_text_from_pdf() {

	return await GET_text_from_file_wo_auth_GitHub_RESTAPI_directurl(file_download_url)
		.then(async function(text_out) {
			// console.log('text_out: ', text_out);
		})

}

	
	
async function GET_text_from_file_wo_auth_GitHub_RESTAPI_directurl(file_download_url) {

	return await fetch(file_download_url)
		.then(res => res.text())
		.then(str_data => { 
			// console.log('str_data: ', str_data); 
			
			// try to decode characters from [stream to endstream]
			let valstofind = /stream(.*?)endstream/g;
			var matches = valstofind.exec(str_data);
			console.log('matches: ', matches);

			var one_match_string = str_data.match(valstofind);
			console.log('one_match_string: ', one_match_string);
			let data_decoded = atob(one_match_string);
			console.log('data_decoded:', data_decoded);
			
			return str_data;
		})
		.catch(error => { console.log(error); });
}
  
// ----------------------------------------------------


// Way 1: use pdf.js
async function transcribe_pdf() {

	let url = file_download_url.split('/').pop();
	console.log("url: ", url);

	var pdfjsLib = window['pdfjs-dist/build/pdf'];
	
	// The workerSrc property shall be specified
	pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://unpkg.com/browse/pdfjs-dist@4.2.67/build/pdf.worker.js';
	
	// Asynchronous download of PDF
	pdfjsLib.getDocument(url)
		.then(response => response)
		.then(async function(pdfDoc) { 
			console.log("pdfDoc: ", pdfDoc);
			// return pdf_blob_object; 
		})
		.catch(error => { console.log(error); });
	
	
	// const pdf = await loadingTask;
  
	// Fetch the first page
	// const page = await pdf.getPage(1);
	// const scale = 1.5;
	// const viewport = page.getViewport({ scale });
	
	// Support HiDPI-screens.
	// const outputScale = window.devicePixelRatio || 1;

	// Prepare canvas using PDF page dimensions
	// const canvas = document.getElementById("the-canvas");
	// const context = canvas.getContext("2d");

	// canvas.width = Math.floor(viewport.width * outputScale);
	// canvas.height = Math.floor(viewport.height * outputScale);
	// canvas.style.width = Math.floor(viewport.width) + "px";
	// canvas.style.height = Math.floor(viewport.height) + "px";
	
	// const transform = outputScale !== 1 ? [outputScale, 0, 0, outputScale, 0, 0] : null;

	// Render PDF page into canvas context
	// const renderContext = {canvasContext: context, transform, viewport,};
	// page.render(renderContext);
	
}

	

// ----------------------------------------------------

// Way 2: try to transcribe pdf with Assistant
async function extract_text_from_pdf_using_OpenAI_assistant() {
	
	await fetch(file_download_url)
		.then(response => response.blob())
		.then(async function(pdf_blob_object) { 
			// console.log("pdf_blob_object: ", pdf_blob_object);
			// return pdf_blob_object; 
			// OR
			// Transform blob into a file
			return new File ([pdf_blob_object], "file.pdf", {type: "application/pdf"});
		})
		// Step A
		//.then(async function(file_pdf_blob_object) { 
			// await upload_files_to_a_vector_store(pdf_blob_object, "", 'blob_object'); 
			//await upload_files_to_a_vector_store(file_pdf_blob_object, "file.pdf", 'file_blob_object'); 
		//})
		// Step B
		//.then(async function() { await create_an_assistant(); })
		// Step C
		//.then(async function() { await create_a_thread(); })
		// Step D
		.then(async function() { await add_a_message_to_a_thread(); })
		// Step E
		.then(async function() { await list_messages_in_a_thread(); })
		// Step F
		.then(async function() { await run_the_assistant(); })
		// Step G
		// .then(async function() { await check_the_run_status(); }) // needs RUN_ID
		// Step H
		.then(async function() { await display_the_assistants_response(); })
		.catch(error => { console.log("error: ", error); });

}
	
// ----------------------------------------------------

// Step A
async function upload_files_to_a_vector_store(file_input, filename, which_input) {
	
	// const url = "https://api.openai.com/v1/vectorStores";
	// Cross-Origin Request Blocked: The Same Origin Policy disallows reading the remote resource at https://api.openai.com/v1/vectorStores. (Reason: CORS header ‘Access-Control-Allow-Origin’ missing). Status code: 404.

	// WORKS!
	const url = "https://api.openai.com/v1/files";

	const headers = new Headers();
	headers.append("Authorization", 'Bearer ' + OPENAI_API_KEY);
	headers.append("Accept", "application/json");
	
	const formData = new FormData();
	if (which_input == 'blob_object') {
		// WORKS: but filename is 'blob', one can not specifically name the file
		formData.append("file", file_input);
	} else {
		// file_blob_object: specifically name the file
		formData.append("file", file_input, filename);
	}
	formData.append("purpose", "assistants");
	
	const options = {method: 'POST', 
		       headers: headers, 
		       body: formData,
		       redirect: "follow"};
	
	await fetch(url, options)
	 	.then(response => response.json())
	 	.then(async function(result) {
			let output = JSON.parse(JSON.stringify(result));
			console.log("output :", output);
			FILE_ID = output['id'];
			console.log('FILE_ID: ', FILE_ID);
			outp.innerHTML = FILE_ID;
		})
	 	.catch(error => { console.log(error); });
}
	
// ----------------------------------------------------

// Step B
async function create_an_assistant() {

	// ------------------------------------------
	
	var url = 'https://api.openai.com/v1/assistants';  // openai.beta.assistants.create OR client.beta.assistants.create
  
	var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY, "OpenAI-Beta": 'assistants=v2'}

	// --------------------
	// Create an assistant for file_search
	// --------------------
	// One can not attach tool_resources to file_search
	// var data = {"name": "pdf transcriber", "description": "You are a transcribing assistant. Transcribe the pdf blob file to text.", "model": "gpt-4-turbo", "tools": [{"type": "file_search"}], "tool_resources": {"file_search":{"file_ids": [FILE_ID]}}};
	// message: "Unknown parameter: 'tool_resources.file_search.file_ids'.", type: "invalid_request_error"
	// OR
	// var data = {"name": "pdf transcriber", "description": "You are a transcribing assistant. Transcribe the pdf blob file to text.", "model": "gpt-4-turbo", "tools": [{"type": "file_search"}]};
	
	// --------------------

	// --------------------
	// Create an assistant for code_interpreter
	// --------------------
	// var data = {"name": "pdf transcriber", "description": "You are a transcribing assistant. Extract the text in the file.", "model": "gpt-4-turbo", "tools": [{"type": "file_search"}], "tool_resources": {"code_interpreter":{"file_ids": [FILE_ID]}}};
	// WORKS, but it was understood that file_search was needed to Transcribe pdf text. 
	// However the file is attached to code_interpreter, thus one can not perform a file_search thread and find the FILE_ID. 
	// OR
	var data = {"name": "pdf transcriber", "description": "You are a transcribing assistant. Extract the text in the file.", "model": "gpt-4-turbo", "tools": [{"type": "code_interpreter"}], "tool_resources": {"code_interpreter":{"file_ids": [FILE_ID]}}};
	// WORKS
	// --------------------
	
	var options = {method : 'post', headers: headers, body : JSON.stringify(data)};
	
	// ------------------------------------------
	
	await fetch(url, options)
		.then(res => res.json())
		.then(res => { 
			let output = JSON.parse(JSON.stringify(res));
			console.log("output: ", output);
		})
		.catch(error => { console.log("error: ", error); });
  
}

// ----------------------------------------------------

// Step C
async function create_a_thread() {
	
	const url = "https://api.openai.com/v1/threads";
	var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY, "OpenAI-Beta": 'assistants=v2'}

	var prompt = "Extract the text from this file."

	// ---------------------------

	// File search enables the assistant with knowledge from files that you or your users upload. Once a file is uploaded, the assistant automatically decides when to retrieve content based on user requests.
	
	// Code Interpreter enables the assistant to write and run code. This tool can process files with diverse data and formatting, and generate files such as graphs.
	
	// var messages = [{"role": "user", "content": prompt, "attachments": [{"file_id": "file.pdf", "tools": [{"type": "file_search"}]}]}];
	// message: "Files [file.pdf] were not found", type: "invalid_request_error"
	
	// var messages = [{"role": "user", "content": prompt, "attachments": [{"file_id": pdf_blob_object, "tools": [{"type": "file_search"}]}]}];
	// message: "Invalid type for 'messages[0].attachments[0].file_id': expected a string, but got an object instead."

	// --------------------
	// Instructions on https://platform.openai.com/docs/assistants/how-it-works/managing-threads-and-messages?lang=python
	var messages = [{"role": "user", "content": prompt, "attachments": [{"file_id": FILE_ID, "tools": [{"type": "code_interpreter"}]}]}];
	// "Files with extensions [none] are not supported for retrieval. See https://platform.openai.com/docs/assistants/tools/file-search/supported-files"
	// OR
	//var messages = [{"role": "user", "content": prompt, "attachments": [{"file_id": FILE_ID+".id", "tools": [{"type": "file_search"}]}]}];
	// Files [file-1kLxcQsAJqbyxB2qdjr81XAl.id] were not found", type: "invalid_request_error"
	// OR
	// var messages = [{"role": "user", "content": prompt, "attachments": [{"file_id": "file.pdf", "tools": [{"type": "code_interpreter"}]}]}];
	// message: "Files [file.pdf] were not found", type: "invalid_request_error"
	// --------------------
	
	// var messages = [{"role": "user", "content": prompt, "tools": [{"type": "file_search"}], "tool_resources": {"file_search":{"file_ids": [FILE_ID]}} }];
	// "Unknown parameter: 'messages[0].tools'."

	// var messages = [{"role": "user", "content": prompt, "tools": [{"type": "code_interpreter"}], "tool_resources": {"code_interpreter":{"file_ids": [FILE_ID]}} }];
	// message: "Unknown parameter: 'messages[0].tools'.", type: "invalid_request_error", param: "messages[0].tools"
	
	// ---------------------------
	
	var data = {"messages": messages};
	
	var options = {method : 'post', headers: headers, body : JSON.stringify(data)};
	
	// ------------------------------------------
	
	await fetch(url, options)
	 	.then(response => response.json())
	 	.then(async function(result) {
			let output = JSON.parse(JSON.stringify(result));
			console.log("output :", output);
			// outp.innerHTML = output;
		})
	 	.catch(error => { console.log("error: ", error); });
	
}
	
// ----------------------------------------------------

// Step D
async function add_a_message_to_a_thread() {

  const url = "https://api.openai.com/v1/threads/"+THREAD_ID+"/messages";
	var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY, "OpenAI-Beta": 'assistants=v2'};
  var data = {"role": "user", "content": "Extract the text from this file."};
  var options = {method : 'post', headers: headers, body : JSON.stringify(data)};
	
	await fetch(url, options)
	 	.then(response => response.json())
	 	.then(async function(result) {
			let output = JSON.parse(JSON.stringify(result));
			console.log("output :", output);
			// outp.innerHTML = output;
		})
	 	.catch(error => { console.log("error: ", error); });
}

// ----------------------------------------------------

// Step E
async function list_messages_in_a_thread() {
  
  const url = "https://api.openai.com/v1/threads/"+THREAD_ID+"/messages";
	var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY, "OpenAI-Beta": 'assistants=v2'};
  var data = {"role": "user", "content": "Text prompt"};
  var options = {method : 'post', headers: headers, body : JSON.stringify(data)};
	
	await fetch(url, options)
	 	.then(response => response.json())
	 	.then(async function(result) {
			let output = JSON.parse(JSON.stringify(result));
			console.log("output :", output);
			// outp.innerHTML = output;
		})
	 	.catch(error => { console.log("error: ", error); });
}
  
// ----------------------------------------------------
  
// Step F
async function run_the_assistant() {

	// Create a run such that the assistant reads the thread and decides whether to call tools or use a model to respond to the query.

	const url = "https://api.openai.com/v1/threads/THREAD_ID/messages";
	var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY, "OpenAI-Beta": 'assistants=v2'};

	// ---------------------------
	// Run original Assistant instructions
	// ---------------------------
	var data = {"assistant_id": ASSISTANT_ID}; 
	// ---------------------------
	// OR
	// ---------------------------
	// Run over riding some of the original Assistant instructions
	// ---------------------------
	// var override_original_prompt = "Extract the text from this file.";  // "New instructions that override the Assistant instructions"
	// var messages = {"assistant_id": assistant_id, "model": "gpt-4-turbo", "instructions": override_original_prompt, "tools": [{"type": "code_interpreter"}, {"type": "file_search"}]};
	// var data = {"messages": messages};
	// ---------------------------
	
	var options = {method : 'post', headers: headers, body : JSON.stringify(data)};
	
	await fetch(url, options)
	 	.then(response => response.json())
	 	.then(async function(result) {
			let output = JSON.parse(JSON.stringify(result));
			console.log("output :", output);
			// outp.innerHTML = output;
		})
	 	.catch(error => { console.log("error: ", error); });
}


// ----------------------------------------------------
  
// Step G
async function check_the_run_status() {

  const url = "https://api.openai.com/v1/threads/"+THREAD_ID+"/runs/"+RUN_ID;
	var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY, "OpenAI-Beta": 'assistants=v2'};

  var options = {method : 'post', headers: headers};
	
	await fetch(url, options)
	 	.then(response => response.json())
	 	.then(async function(result) {
			let output = JSON.parse(JSON.stringify(result));
			console.log("output :", output);
			// outp.innerHTML = output;
		})
	 	.catch(error => { console.log("error: ", error); });

}
  
// ----------------------------------------------------
  
// Step H
async function display_the_assistants_response() {
  
  const url = "https://api.openai.com/v1/threads/"+THREAD_ID+"/messages";
	var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY, "OpenAI-Beta": 'assistants=v2'};

  var options = {method : 'post', headers: headers};
	
	await fetch(url, options)
	 	.then(response => response.json())
	 	.then(async function(result) {
			let output = JSON.parse(JSON.stringify(result));
			console.log("output :", output);
			// outp.innerHTML = output;
		})
	 	.catch(error => { console.log("error: ", error); });

}
  
// ----------------------------------------------------
  
</script>

  </body>
</html>
