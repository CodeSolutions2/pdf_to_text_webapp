<!DOCTYPE html>
<html>
<head></head>
<body>

<h1>An example of extracting text from a pdf</h1>
Type in the url to view a pdf (ie: https://raw.githubusercontent.com/CodeSolutions2/pdf_to_text_webapp/main/document.pdf).

<!-- ---------------------------------------- -->
<!-- Input -->
<input id="pdf_dataset_url" type="text" value="" placeholder="pdf_dataset_url" rows="10" cols="100" style="display:block; text-align: left; width: 600px;">
<input id="OPENAI_API_KEY" type="text" value="" placeholder="OPENAI_API_KEY" rows="10" cols="100" style="display:block; text-align: left; width: 150px;">
<!-- ---------------------------------------- -->
<br>
<!-- ---------------------------------------- -->
<!-- Buttons -->
<button id="show_pdf_wo_CORS" onclick="show_pdf_wo_CORS()">[Step 0] show_pdf_wo_CORS</button>
<br>
<button id="read_text_from_pdf" onclick="read_text_from_pdf()">[Step 1] read_text_from_pdf</but
<br>
<button id="extract_text_from_pdf_using_OpenAI_assistant" onclick="extract_text_from_pdf_using_OpenAI_assistant()">[Step 1] extract_text_from_pdf_using_OpenAI_assistant</button>
<!-- ---------------------------------------- -->
<br>

<div id="output" style="display:none;font-family:courier;font-size:24px;height:300px"></div>

	

<script>
	
const outp = document.getElementById('output');

const file_download_url = document.getElementById("pdf_dataset_url").value;
const OPENAI_API_KEY = document.getElementById("OPENAI_API_KEY").value;



// ----------------------------------------------------
// Step 0
// ----------------------------------------------------
	
// Show pdf without CORS
async function show_pdf_wo_CORS() {
	
	let file_download_url_name = file_download_url.split('/').pop();
	// console.log("file_download_name: ", file_download_url_name);

	// objectElement works
	// https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe
	// https://developer.mozilla.org/en-US/docs/Learn/HTML/Multimedia_and_embedding/Other_embedding_technologies
	var objectElement = document.createElement('object');
	objectElement.setAttribute("type", "application/pdf");
	objectElement.setAttribute("width", 800);
	objectElement.setAttribute("height", 1200);

	// one needs to only put the name of the pdf, instead of the full html_url because the fetch labels the data as cross-site instead of same-site
	objectElement.setAttribute("data", file_download_url_name);
	document.body.appendChild(objectElement);
}

// ----------------------------------------------------







// ----------------------------------------------------
// Step 1
// ----------------------------------------------------
	
// Way 0: try reading text from the pdf
// WORKS
async function read_text_from_pdf() {

	return await GET_text_from_file_wo_auth_GitHub_RESTAPI_directurl(file_download_url)
		.then(async function(text_out) {
			// console.log('text_out: ', text_out);
		})

}

	
	
async function GET_text_from_file_wo_auth_GitHub_RESTAPI_directurl(file_download_url) {

	return await fetch(file_download_url)
		.then(res => res.text())
		.then(str_data => { 
			// console.log('str_data: ', str_data); 
			
			// try to decode characters from [stream to endstream]
			let valstofind = /stream(.*?)endstream/g;
			var matches = valstofind.exec(str_data);
			console.log('matches: ', matches);

			var one_match_string = str_data.match(valstofind);
			console.log('one_match_string: ', one_match_string);
			let data_decoded = atob(one_match_string);
			console.log('data_decoded:', data_decoded);
			
			return str_data;
		})
		.catch(error => { console.log(error); });
}
	

// ----------------------------------------------------

// Way 2: try to transcribe pdf with Assistant
async function extract_text_from_pdf_using_OpenAI_assistant() {
	
	await fetch(file_download_url)
		.then(response => response.blob())
		.then(async function(pdf_blob_object) { 
			// console.log("pdf_blob_object: ", pdf_blob_object);
			return pdf_blob_object; 
		})
		//.then(async function(pdf_blob_object) { await upload_files_to_a_vector_store(pdf_blob_object, "", 'blob_object'); })
		//.then(async function() { await create_an_assistant() })
		.catch(error => { console.log(error); });

}
	

	
async function create_an_assistant() {

	// let file_id = outp.innerHTML;
	let file_id = "file-1kLxcQsAJqbyxB2qdjr81XAl";

	// ------------------------------------------
	
	var url = 'https://api.openai.com/v1/assistants'
  
	var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY, "OpenAI-Beta": 'assistants=v2'}

	var data = {"name": "pdf transcriber", "description": "You are a transcribing assistant. Transcribe the pdf blob file to text.", "model": "gpt-4-turbo", "tools": [{"type": "file_search"}], "tool_resources": {"code_interpreter":{"file_ids": [file_id]}}};
  
	var options = {method : 'post', headers: headers, body : JSON.stringify(data)};
	
	// ------------------------------------------
	
	await fetch(url, options)
		.then(res => res.json())
		.then(res => { 
			let output = JSON.parse(JSON.stringify(res));
			console.log("output: ", output);
		})
		.catch(error => { console.log("error: ", error); });
  
}
	
// ----------------------------------------------------

async function upload_files_to_a_vector_store(file_input, filename, which_input) {
	
	// const url = "https://api.openai.com/v1/vectorStores";
	const url = "https://api.openai.com/v1/files";

	const headers = new Headers();
	headers.append("Authorization", 'Bearer ' + OPENAI_API_KEY);
	headers.append("Accept", "application/json");
	
	const formData = new FormData();
	if (which_input == 'blob_object') {
		// WORKS: but filename is 'blob', one can not specifically name the file
		formData.append("file", file_input);
	} else {
		// file_blob_object: specifically name the file
		formData.append("file", file_input, filename);
	}
	formData.append("purpose", "assistants");
	
	const options = {method: 'POST', 
		       headers: headers, 
		       body: formData,
		       redirect: "follow"};

	
	await fetch(url, options)
	 	.then(response => response.json())
	 	.then(async function(result) {
			let output = JSON.parse(JSON.stringify(result));
			console.log("output :", output);
			let file_id = output['id'];
			console.log('file_id: ', file_id);
			outp.innerHTML = file_id;
		})
	 	.catch(error => { console.log(error); });
}
	
// ----------------------------------------------------


  
</script>

  </body>
</html>
