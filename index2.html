<!DOCTYPE html>
<html>
<head></head>
<body>

<h1>An example of extracting text from a pdf</h1>
Type in the url to view a pdf (ie: https://raw.githubusercontent.com/CodeSolutions2/pdf_to_text_webapp/main/document.pdf).

<input id="pdf_dataset_url" type="text" value="" placeholder="pdf_dataset_url" rows="10" cols="100" style="display:block; text-align: left; width: 600px;">

<br><br>

<button id="show_pdf_wo_CORS" onclick="show_pdf_wo_CORS()">[Step 0] show_pdf_wo_CORS</button>
<br>
<button id="show_pdf_w_CORS" onclick="show_pdf_w_CORS()">[Step 0] show_pdf_w_CORS</button>
<br>
<button id="read_text_from_pdf" onclick="read_text_from_pdf()">[Step 1] read_text_from_pdf</button>
<br>
<button id="transcribe_pdf" onclick="transcribe_pdf()">[Step 1] transcribe_pdf</button>
<br>

<!-- <object style="display:none" data="document.pdf" type="application/pdf" width="800" height="1200"></object> -->

<!-- Way 0: Step 2  -->
<div id="output" style="display:none;font-family:courier;font-size:24px;height:300px"></div>


<canvas id="the-canvas" style="border: 1px solid black; direction: ltr;"></canvas>
	

<!-- this loads: https://www.jsdelivr.com/package/npm/pdfjs-dist -->
<script type="module"> import pdfjsDist from 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.1.392/+esm' </script>

	
	
<script type="module">

const outp = document.getElementById('output');




// ----------------------------------------------------
// Step 0
// ----------------------------------------------------
	
// Show pdf without CORS
async function show_pdf_wo_CORS() {
	
	const file_download_url = document.getElementById("pdf_dataset_url").value;
	
	let file_download_url_name = file_download_url.split('/').pop();
	console.log("file_download_name: ", file_download_url_name);

	// objectElement works
	// https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe
	// https://developer.mozilla.org/en-US/docs/Learn/HTML/Multimedia_and_embedding/Other_embedding_technologies
	var objectElement = document.createElement('object');
	objectElement.setAttribute("type", "application/pdf");
	objectElement.setAttribute("width", 800);
	objectElement.setAttribute("height", 1200);

	// one needs to only put the name of the pdf, instead of the full html_url because the fetch labels the data as cross-site instead of same-site
	objectElement.setAttribute("data", file_download_url_name);
	document.body.appendChild(objectElement);

	// OR

	// iframeElement CAN NOT render pdf
	// https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe
	var iframeElement = document.createElement('iframe');
	iframeElement.setAttribute("type", "application/pdf");
	iframeElement.setAttribute("width", 800);
	iframeElement.setAttribute("height", 1200);
	iframeElement.setAttribute("data", file_download_url_name);
	document.body.appendChild(iframeElement);
	
  
}

// ----------------------------------------------------

// Show pdf WITH CORS
async function show_pdf_w_CORS() {
	
	const file_download_url = document.getElementById("pdf_dataset_url").value;
	
	// Try 0: using embed 
	// var embedElement = document.createElement('embed');
	// embedElement.setAttribute("id", "pdf");
	// embedElement.setAttribute("type", "application/pdf");
	// embedElement.setAttribute("width", 800);
	// embedElement.setAttribute("height", 1200);
	// embedElement.setAttribute("src", file_download_url);
	// document.body.appendChild(embedElement);
	// forbidden to open pdf file from crosss-domain
	
	
	// Try 1: using an iframe : it opens a new page with the pdf inside, and then it tries to 
	var iframeElement = document.createElement('iframe');
	// iframeElement.style.width = '100%';
	// iframeElement.style.height = '100%';
	// iframeElement.style.display = 'none';
	document.body.appendChild(iframeElement);
  
	// The iframe on the main page is connected to another iframe on a new page
	// So, one can open a cross-origin file in a new window, but not in the same window 
	var contentWindow = iframeElement.contentWindow;
	contentWindow.document.open();
	contentWindow.document.write('<iframe src="' + file_download_url + '" onload="print();" width="1000" height="1800" frameborder="0" marginheight="0" marginwidth="0">');
	contentWindow.document.close();

}

// ----------------------------------------------------







// ----------------------------------------------------
// Step 1
// ----------------------------------------------------
	
// Way 0: try reading text from the pdf
async function read_text_from_pdf() {

	const file_download_url = document.getElementById("pdf_dataset_url").value;

	return await GET_text_from_file_wo_auth_GitHub_RESTAPI_directurl(file_download_url)
		.then(async function(text_out) {
			console.log('text_out: ', text_out);
		})

}

	
	
async function GET_text_from_file_wo_auth_GitHub_RESTAPI_directurl(file_download_url) {

	return await fetch(file_download_url)
		.then(res => res.text())
		.then(data => { 
			console.log('data: ', data); return data;
		})
		.catch(error => { console.log(error); });
}
  
// ----------------------------------------------------


// Way 1: use pdf.js
async function transcribe_pdf() {

	const file_download_url = document.getElementById("pdf_dataset_url").value;
	
	let url = file_download_url.split('/').pop();
	console.log("url: ", url);
	
	// The workerSrc property shall be specified
	pdfjsLib.GlobalWorkerOptions.workerSrc = '../../node_modules/pdfjs-dist/build/pdf.worker.mjs';
	
	// Asynchronous download PDF
	const loadingTask = pdfjsLib.getDocument(url);
	const pdf = await loadingTask.promise;
  
	// Fetch the first page
	const page = await pdf.getPage(1);
	const scale = 1.5;
	const viewport = page.getViewport({ scale });
	
	// Support HiDPI-screens.
	const outputScale = window.devicePixelRatio || 1;

	// Prepare canvas using PDF page dimensions
	const canvas = document.getElementById("the-canvas");
	const context = canvas.getContext("2d");

	canvas.width = Math.floor(viewport.width * outputScale);
	canvas.height = Math.floor(viewport.height * outputScale);
	canvas.style.width = Math.floor(viewport.width) + "px";
	canvas.style.height = Math.floor(viewport.height) + "px";
	
	const transform = outputScale !== 1 ? [outputScale, 0, 0, outputScale, 0, 0] : null;

	// Render PDF page into canvas context
	const renderContext = {canvasContext: context, transform, viewport,};
	page.render(renderContext);

}

	

// ----------------------------------------------------

// Way 2: try to transcribe pdf with Assistant
async function extract_text_from_pdf_using_OpenAI_assistant() {
	
	var file_download_url = outp.innerHTML;
	
	await fetch(file_download_url)
  				.then(response => response.blob())
			 	.then(async function(blob_object) { 
					// console.log("blob_object: ", blob_object);
					await call_to_model(blob_object);
				})
				.then(async function() { await new Promise(r => setTimeout(r, 200)); })
				.catch(error => { console.log(error); });

}
	

	
async function call_to_model(pdf_blob) {

	const prompt = `Extract the text from the given pdf blob file: ${pdf_blob}`;
	
	// ------------------------------------------
	var url = 'https://api.openai.com/v1/assistants'
  
	var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY, "OpenAI-Beta": 'assistants=v1'}

  // var system_content = "You are a helpful assistant that can transcribe pdf blob files to text."
	// var assistant_content = "Respond concisely"
	// var messages = [{"role": "system", "content": system_content}, {"role": "user", "content": prompt}, {"role": "assistant", "content": assistant_content}];
	var data = {"instructions": "You are a transcribing assistant. Transcribe the pdf blob file to text.", "name": "Pdf Transcriber", "tools": [], "model": 'gpt-4'};
  
	var options = {method : 'post', headers: headers, body : JSON.stringify(data)};
	// ------------------------------------------
	
	await fetch(url, options)
		.then(res => res.json())
		.then(res => { 
			//const text_out = JSON.parse(JSON.stringify(res))['choices'][0]['message']['content'];
				  console.log('out: ', JSON.parse(JSON.stringify(res))['choices'][0]['message']['content']);
		})
		.catch(error => { console.log(error); });
  
}
// ----------------------------------------------------

  
</script>

  </body>
</html>
