<!DOCTYPE html>
<html>
<head></head>
<body>

<h1>An example of extracting text from a pdf</h1>
Type in the url to view a pdf (ie: https://raw.githubusercontent.com/CodeSolutions2/pdf_to_text_webapp/main/document.pdf).

<!-- ---------------------------------------- -->
<!-- Input -->
<input id="pdf_dataset_url" type="text" value="" placeholder="pdf_dataset_url" rows="10" cols="100" style="display:block; text-align: left; width: 600px;">
<input id="OPENAI_API_KEY" type="text" value="" placeholder="OPENAI_API_KEY" rows="10" cols="100" style="display:block; text-align: left; width: 150px;">
<!-- ---------------------------------------- -->
<br>
<!-- ---------------------------------------- -->
<!-- Buttons -->
<button id="show_pdf_wo_CORS" onclick="show_pdf_wo_CORS()">[Step 0] show_pdf_wo_CORS</button>
<br>
<button id="extract_text_from_pdf_using_OpenAI_assistant" onclick="extract_text_from_pdf_using_OpenAI_assistant()">[Step 1] extract_text_from_pdf_using_OpenAI_assistant</button>
<!-- ---------------------------------------- -->
<br>

<!-- Way 0: Step 2  -->
<div id="output_FILE_ID" style="display:none;font-family:courier;font-size:24px;height:300px"></div>
<div id="output_ASSISTANT_ID" style="display:none;font-family:courier;font-size:24px;height:300px"></div>
<div id="output_THREAD_ID" style="display:none;font-family:courier;font-size:24px;height:300px"></div>
<div id="output_THREAD_MESSAGE_ID" style="display:none;font-family:courier;font-size:24px;height:300px"></div>
<div id="output_RUN_ID" style="display:none;font-family:courier;font-size:24px;height:300px"></div>

	
<script>
	
const out_FILE_ID = document.getElementById('output_FILE_ID');
const out_ASSISTANT_ID = document.getElementById('output_ASSISTANT_ID');
const out_THREAD_ID = document.getElementById('output_THREAD_ID');
const out_THREAD_MESSAGE_ID = document.getElementById('output_THREAD_MESSAGE_ID');
const out_RUN_ID = document.getElementById('output_RUN_ID');

const file_download_url = document.getElementById("pdf_dataset_url").value;
const OPENAI_API_KEY = document.getElementById("OPENAI_API_KEY").value;

var FILE_ID = "";
var ASSISTANT_ID = "";
var THREAD_ID = "";
var THREAD_MESSAGE_ID = "";
var RUN_ID = "";


	
// ----------------------------------------------------
// Step 0
// ----------------------------------------------------
	
// Show pdf without CORS
async function show_pdf_wo_CORS() {
	
	let file_download_url_name = file_download_url.split('/').pop();
	console.log("file_download_name: ", file_download_url_name);

	// objectElement works
	// https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe
	// https://developer.mozilla.org/en-US/docs/Learn/HTML/Multimedia_and_embedding/Other_embedding_technologies
	var objectElement = document.createElement('object');
	objectElement.setAttribute("type", "application/pdf");
	objectElement.setAttribute("width", 800);
	objectElement.setAttribute("height", 1200);

	// one needs to only put the name of the pdf, instead of the full html_url because the fetch labels the data as cross-site instead of same-site
	objectElement.setAttribute("data", file_download_url_name);
	document.body.appendChild(objectElement);
}

// ----------------------------------------------------






// ----------------------------------------------------
// Step 1
// ----------------------------------------------------
async function extract_text_from_pdf_using_OpenAI_assistant() {
	
	await fetch(file_download_url)
		.then(response => response.blob())
		.then(async function(pdf_blob_object) { 
			// console.log("pdf_blob_object: ", pdf_blob_object);
			// return pdf_blob_object; 
			// OR
			// Transform blob into a file
			return new File ([pdf_blob_object], "file.pdf", {type: "application/pdf"});
		})
		// Step A: outputs to out_FILE_ID
		.then(async function(file_pdf_blob_object) { 
			// await upload_files(pdf_blob_object, "", 'blob_object'); 
			await upload_files(file_pdf_blob_object, "file.pdf", 'file_blob_object'); 
		})
		// Step B: outputs to out_ASSISTANT_ID
		.then(async function() { await create_an_assistant(); console.log("FILE_ID: ", out_FILE_ID.innerHTML); console.log("ASSISTANT_ID: ", out_ASSISTANT_ID.innerHTML); })
		// Step C: outputs to out_THREAD_ID
		.then(async function() { await create_a_thread(); console.log("THREAD_ID: ", out_THREAD_ID.innerHTML); })
		// Step D
		.then(async function() { await add_a_message_to_a_thread(); })
		// Step E: outputs to out_RUN_ID
		.then(async function() {  await run_the_assistant(); console.log("RUN_ID: ", out_RUN_ID.innerHTML); })
		// Step F: wait for run to finish
		.then(async function() { 
			let flag = 'wait_for_completion';
			let c = 0;
			let max_allowed_loops = 5;

			await check_the_run_status()
				.then(async function(out) {  await new Promise(r => setTimeout(r, 2000)); return out; })
				.then(async function(out) {
					var run_status = out;
					console.log('check_the_run_status: ', out)
						
					while (flag == 'wait_for_completion') {
						if ((run_status.status == "queued" || run_status.status == "in_progress" || run_status.status == "completed") & c < max_allowed_loops) {
							// wait a bit, call run status again
							run_status = await check_the_run_status()
								.then(async function(out) { await new Promise(r => setTimeout(r, 2000)); return out; })
								.then(async function(run_status) {
									if (run_status.status == "completed") { flag = "stop loop"; }; 
									return run_status; 
								});
					
						} else {
							flag = "stop loop";
						}
						c = c + 1;
					}
					console.log(' FINAL: ', run_status.status)
				})
				.catch(error => { console.log(' error: ', error); });
		})
		.catch(error => { console.log("error: ", error); });
}
	
// ----------------------------------------------------

// Step A
async function upload_files(file_input, filename, which_input) {
	
	const url = "https://api.openai.com/v1/files";

	const headers = new Headers();
	headers.append("Authorization", 'Bearer ' + OPENAI_API_KEY);
	headers.append("Accept", "application/json");
	
	const formData = new FormData();
	if (which_input == 'blob_object') {
		// WORKS: but filename is 'blob', one can not specifically name the file
		formData.append("file", file_input);
	} else {
		// file_blob_object: specifically name the file
		formData.append("file", file_input, filename);
	}
	formData.append("purpose", "assistants");
	
	const options = {method: 'POST', 
		       headers: headers, 
		       body: formData,
		       redirect: "follow"};
	
	await fetch(url, options)
	 	.then(response => response.json())
	 	.then(async function(result) {
			let output = JSON.parse(JSON.stringify(result));
			FILE_ID = output['id'];
			out_FILE_ID.innerHTML = FILE_ID;
		})
	 	.catch(error => { console.log(error); });
}
	
// ----------------------------------------------------

// Step B
async function create_an_assistant() {

	// ------------------------------------------

	// Retreive needed variables
	FILE_ID = out_FILE_ID.innerHTML;

	// ------------------------------------------
	
	var url = 'https://api.openai.com/v1/assistants';  // openai.beta.assistants.create OR client.beta.assistants.create
  
	var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY, "OpenAI-Beta": 'assistants=v2'}

	// --------------------
	// Create an assistant for file_search
	// --------------------
	// One can not attach tool_resources to file_search
	// var data = {"name": "pdf transcriber", "description": "You are a transcribing assistant. Transcribe the pdf blob file to text.", "model": "gpt-4-turbo", "tools": [{"type": "file_search"}], "tool_resources": {"file_search":{"file_ids": [FILE_ID]}}};
	// message: "Unknown parameter: 'tool_resources.file_search.file_ids'.", type: "invalid_request_error"
	// OR
	// var data = {"name": "pdf transcriber", "description": "You are a transcribing assistant. Transcribe the pdf blob file to text.", "model": "gpt-4-turbo", "tools": [{"type": "file_search"}]};
	
	// --------------------

	// --------------------
	// Create an assistant for code_interpreter
	// --------------------
	// var data = {"name": "pdf transcriber", "description": "You are a transcribing assistant. Extract the text in the file.", "model": "gpt-4-turbo", "tools": [{"type": "file_search"}], "tool_resources": {"code_interpreter":{"file_ids": [FILE_ID]}}};
	// WORKS, but it was understood that file_search was needed to Transcribe pdf text. 
	// However the file is attached to code_interpreter, thus one can not perform a file_search thread and find the FILE_ID. 
	// OR
	var prompt = "Extract the text from this file.";
	var data = {"name": "pdf transcriber", 
		    "description": "You are a transcribing assistant. Extract the text in the file.", 
		    "instructions": prompt,
		    "model": "gpt-4-turbo", 
		    "temperature": 0,
		    "tools": [{"type": "code_interpreter"}], 
		    "tool_resources": {"code_interpreter":{"file_ids": [FILE_ID]}}
	};
	// --------------------
	
	var options = {method : 'post', headers: headers, body : JSON.stringify(data)};
	
	// ------------------------------------------
	
	await fetch(url, options)
		.then(res => res.json())
		.then(res => { 
			let output = JSON.parse(JSON.stringify(res));
			ASSISTANT_ID = output['id'];
			out_ASSISTANT_ID.innerHTML = ASSISTANT_ID;
		})
		.catch(error => { console.log("error: ", error); });
  
}



// ----------------------------------------------------

// Step C
async function create_a_thread() {

	// ------------------------------------------

	// Retreive needed variables
	FILE_ID = out_FILE_ID.innerHTML;

	// ------------------------------------------
	
	const url = "https://api.openai.com/v1/threads";
	var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY, "OpenAI-Beta": 'assistants=v2'}

	var prompt = "Extract the text from this file."

	// ---------------------------

	// File search enables the assistant with knowledge from files that you or your users upload. Once a file is uploaded, the assistant automatically decides when to retrieve content based on user requests.
	
	// Code Interpreter enables the assistant to write and run code. This tool can process files with diverse data and formatting, and generate files such as graphs.
	
	// var messages = [{"role": "user", "content": prompt, "attachments": [{"file_id": "file.pdf", "tools": [{"type": "file_search"}]}]}];
	// message: "Files [file.pdf] were not found", type: "invalid_request_error"
	
	// var messages = [{"role": "user", "content": prompt, "attachments": [{"file_id": pdf_blob_object, "tools": [{"type": "file_search"}]}]}];
	// message: "Invalid type for 'messages[0].attachments[0].file_id': expected a string, but got an object instead."

	// --------------------
	// Instructions on https://platform.openai.com/docs/assistants/how-it-works/managing-threads-and-messages?lang=python
	var messages = [{"role": "user", "content": prompt, "attachments": [{"file_id": FILE_ID, "tools": [{"type": "code_interpreter"}]}]}];
	// "Files with extensions [none] are not supported for retrieval. See https://platform.openai.com/docs/assistants/tools/file-search/supported-files"
	// OR
	//var messages = [{"role": "user", "content": prompt, "attachments": [{"file_id": FILE_ID+".id", "tools": [{"type": "file_search"}]}]}];
	// Files [file-1kLxcQsAJqbyxB2qdjr81XAl.id] were not found", type: "invalid_request_error"
	// OR
	// var messages = [{"role": "user", "content": prompt, "attachments": [{"file_id": "file.pdf", "tools": [{"type": "code_interpreter"}]}]}];
	// message: "Files [file.pdf] were not found", type: "invalid_request_error"
	// --------------------
	
	// var messages = [{"role": "user", "content": prompt, "tools": [{"type": "file_search"}], "tool_resources": {"file_search":{"file_ids": [FILE_ID]}} }];
	// "Unknown parameter: 'messages[0].tools'."

	// var messages = [{"role": "user", "content": prompt, "tools": [{"type": "code_interpreter"}], "tool_resources": {"code_interpreter":{"file_ids": [FILE_ID]}} }];
	// message: "Unknown parameter: 'messages[0].tools'.", type: "invalid_request_error", param: "messages[0].tools"
	
	// ---------------------------
	
	var data = {"messages": messages};
	
	var options = {method : 'post', headers: headers, body : JSON.stringify(data)};
	
	// ------------------------------------------
	
	await fetch(url, options)
	 	.then(response => response.json())
	 	.then(async function(result) {
			let output = JSON.parse(JSON.stringify(result));
			THREAD_ID = output['id'];
			out_THREAD_ID.innerHTML = THREAD_ID;
		})
	 	.catch(error => { console.log("error: ", error); });
	
}
	
// ----------------------------------------------------

// Step D
async function add_a_message_to_a_thread() {

	// ------------------------------------------

	// Retreive needed variables
	THREAD_ID = out_THREAD_ID.innerHTML;

	// ------------------------------------------
	
	const url = "https://api.openai.com/v1/threads/"+THREAD_ID+"/messages";
	var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY, "OpenAI-Beta": 'assistants=v2'};

	var prompt = "Extract the text from this file."
	var data = {"role": "user", "content": prompt};
	var options = {method : 'post', headers: headers, body : JSON.stringify(data)};
	
	await fetch(url, options)
	 	.then(response => response.json())
	 	.then(async function(result) {
			let output = JSON.parse(JSON.stringify(result));
			THREAD_MESSAGE_ID = output['id'];
			out_THREAD_MESSAGE_ID.innerHTML = THREAD_MESSAGE_ID;
		})
	 	.catch(error => { console.log("error: ", error); });
}

// ----------------------------------------------------
  
// Step E
async function run_the_assistant() {

	// ------------------------------------------

	// Retreive needed variables
	THREAD_ID = out_THREAD_ID.innerHTML;
	ASSISTANT_ID = out_ASSISTANT_ID.innerHTML;

	// ------------------------------------------
	
	// Create a run such that the assistant reads the thread and decides whether to call tools or use a model to respond to the query.
	const url = "https://api.openai.com/v1/threads/"+THREAD_ID+"/runs";
	var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY, "OpenAI-Beta": 'assistants=v2'};

	// ---------------------------
	// Run original Assistant instructions
	// ---------------------------
	var data = {"assistant_id": ASSISTANT_ID};
	// ---------------------------
	// OR
	// ---------------------------
	// Run over-riding some of the original Assistant instructions
	// ---------------------------
	// var override_original_prompt = "Extract the text from this file.";  // "New instructions that override the Assistant instructions"
	var messages = {"assistant_id": assistant_id, 
			// "model": "gpt-4-turbo", 
			// "instructions": override_original_prompt, 
			// "tools": [{"type": "code_interpreter"}, {"type": "file_search"}],
			"temperature": 0
	};
	var data = {"messages": messages};
	// ---------------------------
	
	var options = {method : 'post', headers: headers, body : JSON.stringify(data)};
	
	await fetch(url, options)
	 	.then(response => response.json())
	 	.then(async function(result) {
			let output = JSON.parse(JSON.stringify(result));
			console.log("run_the_assistant: ", output)
			RUN_ID = output['id'];
			out_RUN_ID.innerHTML = RUN_ID;
		})
	 	.catch(error => { console.log("run_the_assistant error: ", error); });

	// Output contains
	// assistant_id, id (which is RUN_ID), instructions, model, status: "queued", temperature, thread_id, tool_choice: "auto", tools: {type: "code_interpreter"}, top_p: 1, truncation_strategy: {type: "auto", last_messages: null}
	
}


// ----------------------------------------------------
  
// Step F
async function check_the_run_status() {

	// ------------------------------------------

	// Retreive needed variables
	THREAD_ID = out_THREAD_ID.innerHTML;
	RUN_ID = out_RUN_ID.innerHTML;

	// ------------------------------------------
	
	const url = "https://api.openai.com/v1/threads/"+THREAD_ID+"/runs/"+RUN_ID;
	var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY, "OpenAI-Beta": 'assistants=v2'};
	var options = {method : 'post', headers: headers};
	
	return await fetch(url, options)
	 	.then(response => response.json())
	 	.then(async function(result) { return JSON.parse(JSON.stringify(result)); })
	 	.catch(error => { console.log("error: ", error); });

}
  
// ----------------------------------------------------
  
// Step G
async function display_the_assistants_response() {

	// ------------------------------------------

	// Retreive needed variables
	THREAD_ID = out_THREAD_ID.innerHTML;

	// ------------------------------------------
	
	// Idea 0: use GET
	const url = "https://api.openai.com/v1/threads/"+THREAD_ID+"/messages";
	var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY, "OpenAI-Beta": 'assistants=v2'};
	var options = {method : 'GET', headers: headers};


	// Idea 1: use different url string
	// const url = "https://api.openai.com/v1/threads/"+THREAD_ID+"/messages/list";
	// var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + OPENAI_API_KEY, "OpenAI-Beta": 'assistants=v2'};
	// var options = {method : 'POST', headers: headers};
  
	await fetch(url, options)
	 	.then(response => response.json())
	 	.then(async function(result) {
			let output = JSON.parse(JSON.stringify(result));
			console.log("display_the_assistants_response :", output);
		})
	 	.catch(error => { console.log("error: ", error); });

}
  
// ----------------------------------------------------
  
</script>

  </body>
</html>
